<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multi-Customer Invoice Tool (Grass + Manki)</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ---------------- ICONS ---------------- */
const Upload = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>);
const Copy = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>);
const Download = ({ className }) => (<svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>);

/* ---------------- CUSTOMER CONFIG ---------------- */
const CUSTOMERS = {
  grass: {
    name: 'Grass',
    color: 'green',
    dbFileName: 'updated_grass_db.xlsx',
    mappingFormat: 'standard',
    tariffColumns: ['TARIFF NUM', 'TARIFF NUM_1','TARIFF NUM_2','TARIFF NUM_3','TARIFF NUM_4'],
    partNumColumn: 'PRIMARY PART NUM'
  },
  manki: {
    name: 'Manki',
    color: 'orange',
    dbFileName: 'updated_manki_db.xlsx',
    mappingFormat: 'manki',
    tariffColumns: ['TARIFF NUM','TARIFF NUM_1','TARIFF NUM_2','TARIFF NUM_3','TARIFF NUM_4','TARIFF NUM_5'],
    partNumColumn: 'PRIMARY PART NUM'
  }
};

/* ---------------- UTILITY ---------------- */
const normalizeTariff = (t) => String(t || '').replace(/\D/g, '').trim();

/* ---------------- MAIN COMPONENT ---------------- */
function MultiCustomerTool() {
  const [selectedCustomer, setSelectedCustomer] = useState('grass');
  const [invoiceData, setInvoiceData] = useState([]);
  const [dbData, setDbData] = useState([]);
  const [tariffMappings, setTariffMappings] = useState([]);
  const [selectedRow, setSelectedRow] = useState(null);
  const [msg, setMsg] = useState(null);
  const [fileName, setFileName] = useState('');
  const fileRef = useRef(null);
  const customer = CUSTOMERS[selectedCustomer];

  /* ---------------- LOAD DATABASE ---------------- */
  useEffect(() => { loadDb(); }, [selectedCustomer]);

  const loadDb = async () => {
    setMsg({ type: 'info', text: `Loading ${customer.name} DB...` });
    try {
      const res = await fetch(customer.dbFileName);
      if (!res.ok) throw new Error('Database not found');
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf);
      const main = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
      setDbData(main);
      if (wb.SheetNames.includes('Sheet1')) {
        const sheet1 = XLSX.utils.sheet_to_json(wb.Sheets['Sheet1'], { header: 1, defval: '' });
        setTariffMappings(sheet1.slice(1));
      }
      setMsg({ type: 'success', text: `${customer.name} DB loaded (${main.length} rows)` });
    } catch (err) {
      setMsg({ type: 'error', text: err.message });
    }
  };

  /* ---------------- FILE UPLOAD ---------------- */
  const handleFile = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      const wb = XLSX.read(ev.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { defval: '' });
      setInvoiceData(data);
      setFileName(f.name);
      setMsg({ type: 'success', text: `Loaded ${data.length} rows` });
    };
    r.readAsArrayBuffer(f);
  };

  /* ---------------- FIND TARIFF VALUE ---------------- */
  const findTariffValue = (partNumber, material, mode='content') => {
    const cfg = customer;
    const record = dbData.find(r => String(r[cfg.partNumColumn]||'').trim() === String(partNumber||'').trim());
    if (!record)
      return { value: material==='aluminum' ? 'ALL ALUM GENERIC' : 'ALL STEEL GENERIC', note:'Part not found' };

    const tariffs = cfg.tariffColumns.map(c => String(record[c]||'').trim()).filter(Boolean);
    if (tariffs.length === 0)
      return { value: material==='aluminum' ? 'ALL ALUM GENERIC' : 'ALL STEEL GENERIC', note:'No tariff found' };

    const tariffNumber = normalizeTariff(tariffs[0]);
    const mapping = tariffMappings.find(row => {
      const tariffCol = normalizeTariff(row[0]);
      if (cfg.mappingFormat === 'manki') {
        // For Manki, direct match only
        return tariffCol === tariffNumber;
      } else {
        // Standard (Grass etc.): need EXCL marker for content
        const aluminumCol = String(row[1] || '').trim();
        const steelCol = String(row[2] || '').trim();
        return tariffCol === tariffNumber &&
               (aluminumCol.includes('EXCL') || steelCol.includes('EXCL'));
      }
    });

    if (!mapping)
      return { value: mode==='all'
        ? (material==='aluminum' ? 'ALL ALUM GENERIC' : 'ALL STEEL GENERIC')
        : (material==='aluminum' ? 'ALUM EXCL GENERIC' : 'STEEL EXCL GENERIC'),
        note:'No mapping found' };

    const isManki = cfg.mappingFormat === 'manki';
    const col = material==='aluminum' ? (isManki ? 1 : (mode==='all'?1:1)) : (isManki ? 2 : (mode==='all'?2:2));
    const val = mapping[col] || (material==='aluminum' ? 'ALUM GENERIC' : 'STEEL GENERIC');
    return { value: val.trim(), note:`Matched tariff ${tariffNumber}` };
  };

  /* ---------------- BUTTON ACTIONS ---------------- */
  const applyTariff = (material, mode='content') => {
    if (selectedRow===null) { setMsg({type:'error',text:'Select a row first'}); return; }
    const row = invoiceData[selectedRow];
    const part = row.BuyerPartNumber;
    const result = findTariffValue(part, material, mode);

    const newRow = { ...row, BuyerPartNumber: result.value, SupplierPartNumber: result.value };
    const updated = [...invoiceData];
    if (mode==='all') {
      // Replace in place for ALL modes
      updated[selectedRow] = newRow;
    } else {
      // Duplicate for content modes
      updated.splice(selectedRow+1, 0, newRow);
    }

    setInvoiceData(updated);
    setMsg({ type: 'success', text: `${result.value} applied (${result.note})` });
  };

  /* ---------------- DOWNLOAD ---------------- */
  const downloadFile = () => {
    if (!invoiceData.length) { setMsg({ type: 'error', text: 'No data to download' }); return; }
    const ws = XLSX.utils.json_to_sheet(invoiceData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
    const outName = fileName.replace('.xlsx', `_${selectedCustomer}_updated.xlsx`);
    XLSX.writeFile(wb, outName);
    setMsg({ type: 'success', text: `Downloaded: ${outName}` });
  };

  /* ---------------- UI ---------------- */
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4">
      <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4">
        <h1 className="text-xl font-bold mb-3">Multi-Customer Invoice Tool (Grass + Manki)</h1>

        <div className="flex gap-2 mb-3">
          {Object.entries(CUSTOMERS).map(([k,c])=>(
            <button key={k} onClick={()=>setSelectedCustomer(k)}
              className={`px-4 py-2 rounded-lg text-sm font-semibold ${selectedCustomer===k?`bg-${c.color}-600 text-white`:'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
              {c.name}
            </button>
          ))}
        </div>

        {msg && (
          <div className={`p-3 mb-3 rounded border ${msg.type==='success'?'bg-green-50 border-green-200 text-green-700':msg.type==='error'?'bg-red-50 border-red-200 text-red-700':'bg-blue-50 border-blue-200 text-blue-700'}`}>
            {msg.text}
          </div>
        )}

        <div className="flex gap-2 mb-3 flex-wrap">
          <input type="file" ref={fileRef} onChange={handleFile} accept=".xlsx,.xls" className="hidden"/>
          <button onClick={()=>fileRef.current?.click()} className="flex items-center gap-2 px-4 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700"><Upload className="w-4 h-4"/> Upload Invoice</button>

          <button onClick={()=>applyTariff('aluminum','all')} disabled={selectedRow===null} className="flex items-center gap-2 px-4 py-2 text-sm bg-sky-600 text-white rounded-lg hover:bg-sky-700"><Copy className="w-4 h-4"/> All Aluminum</button>

          <button onClick={()=>applyTariff('steel','all')} disabled={selectedRow===null} className="flex items-center gap-2 px-4 py-2 text-sm bg-gray-700 text-white rounded-lg hover:bg-gray-800"><Copy className="w-4 h-4"/> All Steel</button>

          <button onClick={()=>applyTariff('aluminum','content')} disabled={selectedRow===null} className="flex items-center gap-2 px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700"><Copy className="w-4 h-4"/> Aluminum Content</button>

          <button onClick={()=>applyTariff('steel','content')} disabled={selectedRow===null} className="flex items-center gap-2 px-4 py-2 text-sm bg-slate-600 text-white rounded-lg hover:bg-slate-700"><Copy className="w-4 h-4"/> Steel Content</button>

          <button onClick={downloadFile} disabled={!invoiceData.length} className="flex items-center gap-2 px-4 py-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700"><Download className="w-4 h-4"/> Download</button>
        </div>

        {invoiceData.length>0 && (
          <div className="overflow-x-auto">
            <table className="w-full text-sm border">
              <thead className="bg-gray-50 sticky top-0">
                <tr>
                  <th className="px-3 py-2 border">#</th>
                  <th className="px-3 py-2 border">Invoice #</th>
                  <th className="px-3 py-2 border">Supplier Part #</th>
                  <th className="px-3 py-2 border">Description</th>
                  <th className="px-3 py-2 border">Quantity</th>
                  <th className="px-3 py-2 border">Unit Price</th>
                  <th className="px-3 py-2 border">Item Total</th>
                </tr>
              </thead>
              <tbody>
                {invoiceData.map((row,i)=>(
                  <tr key={i} onClick={()=>setSelectedRow(i)} className={`${selectedRow===i?'bg-green-50':''} cursor-pointer`}>
                    <td className="px-3 py-2 border">{i+1}</td>
                    <td className="px-3 py-2 border">{row.InvoiceNumber}</td>
                    <td className="px-3 py-2 border">{row.SupplierPartNumber}</td>
                    <td className="px-3 py-2 border">{row.Description}</td>
                    <td className="px-3 py-2 border text-right">{row.Quantity}</td>
                    <td className="px-3 py-2 border text-right">{row.UnitPrice}</td>
                    <td className="px-3 py-2 border text-right">{row.ItemTotal}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<MultiCustomerTool />);
</script>
</body>
</html>
